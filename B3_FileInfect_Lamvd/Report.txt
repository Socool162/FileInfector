## PhÃ¢n TÃ­ch & ÄÃ¡nh GiÃ¡ Chi Tiáº¿t Tá»«ng TiÃªu ChÃ­ B3 FileInfector ğŸ§

TiÃªu chÃ­ 1: Chá»‰ cÃ³ má»™t tiáº¿n trÃ¬nh lÃ¢y lan (dÃ¹ng Mutex) âœ…

	PhÃ¢n tÃ­ch: Sá»­ dá»¥ng CreateMutexA vá»›i má»™t tÃªn cá»‘ Ä‘á»‹nh (PEInfectorMutex) ngay khi chÆ°Æ¡ng trÃ¬nh khá»Ÿi Ä‘á»™ng. Sau Ä‘Ã³, báº¡n kiá»ƒm tra káº¿t quáº£ cá»§a GetLastError Ä‘á»ƒ xem cÃ³ báº±ng ERROR_ALREADY_EXISTS hay khÃ´ng. Äáº£m báº£o chá»‰ cÃ³ má»™t instance cá»§a chÆ°Æ¡ng trÃ¬nh Ä‘ang cháº¡y táº¡i má»™t thá»i Ä‘iá»ƒm. 

Äoáº¡n mÃ£
invoke CreateMutexA, NULL, FALSE, ADDR mutex_name
invoke GetLastError
.IF eax == ERROR_ALREADY_EXISTS
    jmp @@exit
.ENDIF


TiÃªu chÃ­ 2: Hiá»ƒn thá»‹ MessageBox khi file bá»‹ nhiá»…m Ä‘Æ°á»£c thá»±c thi âœ… 

PhÃ¢n tÃ­ch: Pháº§n virus_stub 
	DÃ¹ng ká»¹ thuáº­t call delta_offset / pop ebp Ä‘á»ƒ láº¥y Ä‘á»‹a chá»‰ cÆ¡ sá»Ÿ cá»§a stub trong bá»™ nhá»›. Viá»‡c trá»« Ä‘i offset (sub ebp, (offset delta_offset - offset virus_stub)) lÃ  cáº§n thiáº¿t, Ä‘áº£m báº£o ebp luÃ´n trá» Ä‘Ãºng vÃ o Ä‘áº§u stub dÃ¹ nÃ³ Ä‘Æ°á»£c chÃ©p Ä‘i báº¥t cá»© Ä‘Ã¢u.

	Runtime API Loading: Stub khÃ´ng gá»i trá»±c tiáº¿p MessageBoxA mÃ  náº¡p user32.dll qua LoadLibraryA, sau Ä‘Ã³ láº¥y Ä‘á»‹a chá»‰ MessageBoxA qua GetProcAddress. CÃ¡c Ä‘á»‹a chá»‰ cá»§a hai hÃ m nÃ y Ä‘Æ°á»£c "patch" vÃ o stub trong quÃ¡ trÃ¬nh lÃ¢y nhiá»…m.


TiÃªu chÃ­ 3: TÃ¬m file PE 32-bit (.exe vÃ  .dll) trong L:\test âœ…

	PhÃ¢n tÃ­ch: Sá»­ dá»¥ng FindFirstFileA / FindNextFileA vá»›i Ä‘Æ°á»ng dáº«n L:\test\*.*.

	Lá»c file PE 32-bit: MÃ£ cá»§a tÃ´i khÃ´ng lá»c file dá»±a trÃªn pháº§n má»Ÿ rá»™ng (.exe hay .dll). Thay vÃ o Ä‘Ã³, báº¡n Ä‘á»c vÃ  kiá»ƒm tra header cá»§a má»i file tÃ¬m Ä‘Æ°á»£c Ä‘á»ƒ xÃ¡c Ä‘á»‹nh xem nÃ³ cÃ³ pháº£i lÃ  file PE 32-bit há»£p lá»‡ hay khÃ´ng ('ZM' signature, 'PE' signature, IMAGE_FILE_MACHINE_I386).


TiÃªu chÃ­ 4: Kiá»ƒm tra infection marker (trÃ¡nh lÃ¢y nhiá»…m trÃ¹ng) âœ… 

	PhÃ¢n tÃ­ch: HÃ m CheckInfected 
	- TÃ´i duyá»‡t qua tá»«ng section header cá»§a file PE vÃ  so sÃ¡nh tÃªn cá»§a chÃºng vá»›i chuá»—i marker ".infect". 



TiÃªu chÃ­ 5: CÆ¡ cháº¿ lÃ¢y nhiá»…m (thÃªm section, sá»­a Entry Point) âœ… 

	PhÃ¢n tÃ­ch: ThÃªm Section Má»›i

	HÃ m AddInfectionSection tÃ­nh toÃ¡n chÃ­nh xÃ¡c cÃ¡c giÃ¡ trá»‹ quan trá»ng cho section header má»›i: VirtualAddress, PointerToRawData (cÃ³ tÃ­nh Ä‘áº¿n SectionAlignment vÃ  FileAlignment), VirtualSize, vÃ  SizeOfRawData.

	Äáº·t TÃªn Section: Äáº·t tÃªn section má»›i lÃ  ".infect", Ä‘Ã¡p á»©ng Ä‘Ãºng yÃªu cáº§u vÃ  liÃªn káº¿t cháº·t cháº½ vá»›i TiÃªu chÃ­ 4.

	Cáº­p nháº­t PE Header: TÄƒng NumberOfSections, cáº­p nháº­t SizeOfImage, vÃ  quan trá»ng nháº¥t lÃ  thay Ä‘á»•i AddressOfEntryPoint Ä‘á»ƒ trá» Ä‘áº¿n RVA cá»§a section má»›i.

	Sao chÃ©p MÃ£ Ä‘á»™c: Trong hÃ m InfectFile, báº¡n chÃ©p virus_stub vÃ o vá»‹ trÃ­ Ä‘Ã£ Ä‘Æ°á»£c tÃ­nh toÃ¡n trong buffer.

	Patching Stub: Báº¡n Ä‘Ã£ patch cÃ¡c Ä‘á»‹a chá»‰ cáº§n thiáº¿t (pLoadLibraryA, pGetProcAddress, original_entry_point_val, vÃ  rva_stub) vÃ o trong báº£n sao cá»§a stub. Viá»‡c patch rva_stub lÃ  má»™t bÆ°á»›c ráº¥t quan trá»ng Ä‘á»ƒ stub cÃ³ thá»ƒ hoáº¡t Ä‘á»™ng Ä‘Ãºng trong mÃ´i trÆ°á»ng cÃ³ ASLR.



TiÃªu chÃ­ 6: Äáº£m báº£o file gá»‘c váº«n hoáº¡t Ä‘á»™ng bÃ¬nh thÆ°á»ng âœ… 
	
	PhÃ¢n tÃ­ch: Logic tráº£ quyá»n Ä‘iá»u khiá»ƒn vá» chÆ°Æ¡ng trÃ¬nh gá»‘c (host) trong virus_stub vÃ  cÃ³ kháº£ nÄƒng chá»‘ng ASLR.

	ImageBase_Thá»±c_Táº¿ = EBP (Äá»‹a chá»‰ tuyá»‡t Ä‘á»‘i cá»§a stub) - RVA_cá»§a_stub

	Äá»‹a chá»‰ OEP tuyá»‡t Ä‘á»‘i = ImageBase_Thá»±c_Táº¿ + OEP_Ä‘Ã£_lÆ°u

	jmp eax ÄÃ¢y lÃ  cÃ¡ch lÃ m chuáº©n má»±c Ä‘á»ƒ tÃ­nh toÃ¡n Ä‘á»‹a chá»‰ cá»§a Original Entry Point (OEP) táº¡i thá»i Ä‘iá»ƒm thá»±c thi vÃ  chuyá»ƒn hÆ°á»›ng Ä‘áº¿n Ä‘Ã³. Ká»¹ thuáº­t nÃ y Ä‘áº£m báº£o file gá»‘c sáº½ tiáº¿p tá»¥c cháº¡y nhÆ° bÃ¬nh thÆ°á»ng sau khi mÃ£ Ä‘á»™c Ä‘Ã£ thá»±c thi xong.



TiÃªu chÃ­ 7: KhÃ´ng lÃ¢y file há»‡ thá»‘ng (.sys) vÃ  chÃ­nh nÃ³ âœ… 
	PhÃ¢n tÃ­ch:

	Bá» qua file .sys: HÃ m IsSystemFile thá»±c hiá»‡n Ä‘Ãºng chá»©c nÄƒng báº±ng cÃ¡ch tÃ¬m pháº§n má»Ÿ rá»™ng cá»§a file vÃ  so sÃ¡nh vá»›i "sys".

	Bá» qua chÃ­nh nÃ³: Trong infection_loop, báº¡n láº¥y Ä‘Æ°á»ng dáº«n cá»§a chÃ­nh file virus báº±ng GetModuleFileNameA, sau Ä‘Ã³ so sÃ¡nh nÃ³ vá»›i Ä‘Æ°á»ng dáº«n cá»§a file má»¥c tiÃªu. ÄÃ¢y lÃ  cÃ¡ch lÃ m Ä‘Æ¡n giáº£n vÃ  hiá»‡u quáº£.


END.